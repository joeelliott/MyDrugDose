from pathlib import Path, PurePosixPath

html = r"""<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pediatric Transport Dosage Calculator (from protocol PDF)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; line-height: 1.35; }
    h1 { font-size: 1.25rem; margin: 0 0 8px; }
    .sub { opacity: 0.85; margin: 0 0 16px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .card { border: 1px solid rgba(127,127,127,0.35); border-radius: 12px; padding: 14px; }
    label { display: block; font-weight: 600; margin: 10px 0 6px; }
    input, select { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid rgba(127,127,127,0.45); background: transparent; }
    input[type="number"] { appearance: textfield; }
    .small { font-size: 0.9rem; opacity: 0.85; }
    .warn { border-left: 4px solid #d97706; padding-left: 10px; }
    .ok { border-left: 4px solid #16a34a; padding-left: 10px; }
    .btnrow { display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; }
    button { padding: 10px 12px; border: 1px solid rgba(127,127,127,0.45); border-radius: 10px; cursor: pointer; background: transparent; }
    button:hover { filter: brightness(1.05); }
    pre { white-space: pre-wrap; word-break: break-word; border-radius: 12px; padding: 12px; border: 1px solid rgba(127,127,127,0.35); margin: 0; }
    .grid3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .muted { opacity: 0.8; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; border: 1px solid rgba(127,127,127,0.35); font-size: 0.8rem; opacity: 0.9; }
    @media (max-width: 900px) { .row { grid-template-columns: 1fr; } .grid3 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>Pediatric Transport Dosage Calculator</h1>
  <p class="sub">
    Single-file, offline HTML. Calculations are weight-based and mirror specific statements in your protocol PDF.
    <span class="pill">No data leaves this device</span>
  </p>

  <div class="row">
    <div class="card">
      <h2 style="font-size:1.05rem;margin:0 0 10px;">Patient inputs</h2>

      <div class="grid3">
        <div>
          <label for="weightKg">Weight (kg)</label>
          <input id="weightKg" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g., 12.5">
          <div class="small muted">Used for all calculators.</div>
        </div>
        <div>
          <label for="ageGroup">Age group (optional)</label>
          <select id="ageGroup">
            <option value="">(not used)</option>
            <option>Neonate</option>
            <option>Infant</option>
            <option>Child</option>
            <option>Adolescent</option>
          </select>
          <div class="small muted">For documentation only.</div>
        </div>
        <div>
          <label for="units">Display units</label>
          <select id="units">
            <option value="metric" selected>metric (kg, mL)</option>
            <option value="us">US (kg + lb shown)</option>
          </select>
          <div class="small muted">Does not change calculations.</div>
        </div>
      </div>

      <label for="protocol">Protocol / scenario</label>
      <select id="protocol"></select>

      <div id="protocolInputs"></div>

      <div class="btnrow">
        <button id="calcBtn">Calculate</button>
        <button id="resetBtn" title="Clears scenario-specific inputs (keeps weight)">Reset scenario inputs</button>
        <button id="copyBtn" title="Copy results to clipboard">Copy results</button>
      </div>

      <p class="small warn" style="margin-top:12px;">
        Safety: This tool is a convenience calculator only. Always confirm dose, concentration, route,
        patient-specific contraindications, and local policies before administration.
      </p>
    </div>

    <div class="card">
      <h2 style="font-size:1.05rem;margin:0 0 10px;">Results</h2>
      <div class="small muted" id="summaryLine"></div>
      <pre id="output" class="ok">Enter weight, choose a protocol, then click Calculate.</pre>
    </div>
  </div>

<script>
/**
 * Utilities
 */
const roundTo = (x, decimals=2) => {
  if (!isFinite(x)) return NaN;
  const p = Math.pow(10, decimals);
  return Math.round((x + Number.EPSILON) * p) / p;
};

const clampMax = (val, max) => (val > max ? max : val);

const fmt = (x, unit="", decimals=2) => {
  if (x === null || x === undefined || !isFinite(x)) return "—";
  return `${roundTo(x, decimals)}${unit}`;
};

const kgToLb = (kg) => kg * 2.2046226218;

function hollidaySegarMlPerDay(weightKg) {
  // Standard maintenance: 100/50/20 (mL/kg/day)
  // 0-10 kg: 100 mL/kg/day
  // 10-20 kg: 1000 + 50*(kg-10)
  // >20 kg: 1500 + 20*(kg-20)
  if (weightKg <= 0) return 0;
  if (weightKg <= 10) return 100 * weightKg;
  if (weightKg <= 20) return 1000 + 50 * (weightKg - 10);
  return 1500 + 20 * (weightKg - 20);
}

/**
 * Protocol definitions (data-driven)
 * You can add new protocols by appending to PROTOCOLS.
 */
const PROTOCOLS = [
  {
    id: "anaphylaxis",
    name: "Anaphylaxis (P-02): epi IM + diphenhydramine + dexamethasone",
    inputs: [
      { id:"systems", label:"Organ system involvement", type:"select",
        options:[
          {v:"multi_or_airway", t:"≥2 systems OR airway involvement"},
          {v:"single_non_airway", t:"Single system (not airway)"}
        ],
        default:"multi_or_airway"
      }
    ],
    calc: (w, v) => {
      const lines = [];
      lines.push("ANAPHYLAXIS MEDS (weight-based):");
      const epiMg = clampMax(0.01 * w, 0.3);
      lines.push(`• Epinephrine 1 mg/mL (1:1000) IM: ${fmt(epiMg," mg",3)} (0.01 mg/kg, max 0.3 mg)`);
      lines.push(`  → Volume (1 mg/mL): ${fmt(epiMg," mL",3)} IM`);

      const diphen = clampMax(1.0 * w, 50);
      const dex = clampMax(0.6 * w, 16);

      if (v.systems === "multi_or_airway") {
        lines.push(`• Diphenhydramine IV/IM: ${fmt(diphen," mg",1)} (1 mg/kg, max 50 mg)`);
        lines.push(`• Dexamethasone IV/PO: ${fmt(dex," mg",1)} (0.6 mg/kg, max 16 mg)`);
        lines.push("• Albuterol neb: 2.5 mg in 3 mL NS (if wheeze/dyspnea)");
        lines.push("Notes: Epinephrine IM may be repeated q5–15 min if needed; contact medical control after 2 IM doses if persistent symptoms.");
      } else {
        lines.push(`SINGLE SYSTEM (NOT airway):`);
        lines.push(`• Diphenhydramine IV/IM x1: ${fmt(diphen," mg",1)} (1 mg/kg, max 50 mg)`);
        lines.push(`• Dexamethasone IV/PO: ${fmt(dex," mg",1)} (0.6 mg/kg, max 16 mg)`);
        lines.push("• Reassess for improvement; supportive care if hemodynamically stable.");
      }
      return lines.join("\n");
    }
  },

  {
    id: "asthma_severe",
    name: "Asthma (P-03): severe adjuncts (MgSO₄, epi IM, terbutaline, ketamine)",
    inputs: [
      { id:"want_ketamine", label:"Include ketamine dosing?", type:"checkbox", default:true },
      { id:"want_terb", label:"Include terbutaline dosing?", type:"checkbox", default:true },
      { id:"want_epi", label:"Include epinephrine IM dosing?", type:"checkbox", default:true }
    ],
    calc: (w, v) => {
      const lines = [];
      lines.push("SEVERE ASTHMA – ADJUNCTIVE DOSING:");
      const mgMg = clampMax(75 * w, 2000); // mg
      lines.push(`• Magnesium sulfate IV: ${fmt(mgMg," mg",0)} (${fmt(mgMg/1000," g",3)}) (75 mg/kg, max 2 g) over 15 min`);
      lines.push("  Notes: If already given, may redose after 2 hours; if incomplete/slow >20 min, redose FULL dose over 15 min.");

      if (v.want_epi) {
        const epiMg = clampMax(0.01 * w, 0.3);
        lines.push(`• Epinephrine 1 mg/mL IM: ${fmt(epiMg," mg",3)} (0.01 mg/kg, max 0.3 mg)`);
        lines.push(`  → Volume (1 mg/mL): ${fmt(epiMg," mL",3)} IM`);
      }

      if (v.want_ketamine) {
        const kBolusLow = 0.5 * w, kBolusHigh = 1.0 * w;
        const kInfLow = 1.0 * w, kInfHigh = 2.0 * w; // mg/hr
        lines.push(`• Ketamine bolus: ${fmt(kBolusLow,"–",1)}${fmt(kBolusHigh," mg",1)} (0.5–1 mg/kg)`);
        lines.push(`• Ketamine infusion: ${fmt(kInfLow,"–",1)}${fmt(kInfHigh," mg/hr",1)} (1–2 mg/kg/hr)`);
      }

      if (v.want_terb) {
        const terbMcg = clampMax(10 * w, 250);
        lines.push(`• Terbutaline SubQ: ${fmt(terbMcg," mcg",0)} (10 mcg/kg, max 250 mcg)`);
        lines.push(`• Terbutaline infusion range: ${fmt(0.1*w,"–",2)}${fmt(10*w," mcg/min",2)} (0.1–10 mcg/kg/min)`);
      }

      return lines.join("\n");
    }
  },

  {
    id: "dka",
    name: "Diabetic Ketoacidosis (P-08): NS bolus, insulin infusion, 2x maintenance (two-bag)",
    inputs: [
      { id:"bg", label:"Current blood glucose (mg/dL)", type:"number", step:"1", min:"0", placeholder:"e.g., 420" },
      { id:"use_standard", label:"Use standard 2-bag fluids (0.45% NaCl / D10 0.45% NaCl)", type:"checkbox", default:true },
      { id:"want_ce_saline", label:"Show hypertonic saline for cerebral edema (if indicated)", type:"checkbox", default:true }
    ],
    calc: (w, v) => {
      const lines = [];
      lines.push("PEDIATRIC DKA – TRANSPORT STARTER CALCS:");

      // NS bolus
      const nsBolus = clampMax(20 * w, 1000);
      lines.push(`• Normal Saline bolus: ${fmt(nsBolus," mL",0)} (20 mL/kg, max 1000 mL) over 1 hour`);

      // insulin infusion
      const insulinUhr = 0.1 * w;
      lines.push(`• Regular insulin infusion: ${fmt(insulinUhr," units/hr",2)} (0.1 units/kg/hr)`);
      lines.push("  Notes: Do not adjust without medical control.");

      // Maintenance
      const mLday = hollidaySegarMlPerDay(w);
      const mLhr = mLday / 24.0;
      const twoX = 2 * mLhr;
      const capped = Math.min(twoX, 250);
      lines.push(`• Maintenance (Holliday–Segar): ${fmt(mLhr," mL/hr",1)} (based on ${fmt(mLday," mL/day",0)})`);
      lines.push(`• Start fluids at 2× maintenance: ${fmt(twoX," mL/hr",1)} → capped at ${fmt(capped," mL/hr",0)} (max total fluid rate 250 mL/hr, not including insulin)`);

      // Two-bag split
      const bg = Number(v.bg);
      const bagA = v.use_standard ? "0.45% NaCl" : "0.9% NaCl";
      const bagB = v.use_standard ? "D10 0.45% NaCl" : "D10 0.9% NaCl";

      lines.push(`\nTWO-BAG METHOD (total = ${fmt(capped," mL/hr",0)}):`);
      if (!isFinite(bg) || bg <= 0) {
        lines.push("• Enter a blood glucose to auto-split fluids per table.");
        lines.push(`• Bags: A=${bagA}, B=${bagB}`);
      } else {
        let aRate = 0, bRate = 0;
        if (bg < 200) { aRate = 0; bRate = capped; }
        else if (bg >= 201 && bg <= 300) { aRate = capped/2; bRate = capped/2; }
        else { aRate = capped; bRate = 0; }

        lines.push(`• BG = ${bg} mg/dL`);
        lines.push(`• Bag A (${bagA}) rate: ${fmt(aRate," mL/hr",0)}`);
        lines.push(`• Bag B (${bagB}) rate: ${fmt(bRate," mL/hr",0)}`);
        lines.push("  Table reference: <200 → 0 / 2×MIVF; 201–300 → 1×MIVF / 1×MIVF; >301 → 2×MIVF / 0.");
      }

      if (v.want_ce_saline) {
        const htMin = 3 * w;
        const htMax = 5 * w;
        const htMinC = clampMax(htMin, 500);
        const htMaxC = clampMax(htMax, 500);
        lines.push(`\nCEREBRAL EDEMA (if suspected; per protocol guidance):`);
        lines.push(`• 3% hypertonic saline: ${fmt(htMinC,"–",0)}${fmt(htMaxC," mL",0)} (3–5 mL/kg, max 500 mL) over ~10 min`);
        lines.push("  Caution: use caution if corrected Na ≥150 mEq/L.");
      }

      return lines.join("\n");
    }
  },

  {
    id: "seizure_metabolic",
    name: "Seizure (P-18): D10W bolus for BG<60; 3% hypertonic if Na<130 & actively seizing",
    inputs: [
      { id:"is_hypo", label:"Glucose < 60 mg/dL?", type:"checkbox", default:true },
      { id:"is_hypona", label:"Na < 130 AND actively seizing?", type:"checkbox", default:false }
    ],
    calc: (w, v) => {
      const lines = [];
      lines.push("SEIZURE – METABOLIC CORRECTIONS:");

      if (v.is_hypo) {
        const d10 = clampMax(5 * w, 100);
        lines.push(`• D10W: ${fmt(d10," mL",0)} (5 mL/kg, max 100 mL) over 2–5 min`);
      } else {
        lines.push("• D10W: (not selected) check glucose per protocol.");
      }

      if (v.is_hypona) {
        const ht = clampMax(3 * w, 250);
        lines.push(`• 3% hypertonic saline: ${fmt(ht," mL",0)} (3 mL/kg, max 250 mL) over 10–20 min`);
      } else {
        lines.push("• 3% hypertonic saline: only if Na <130 AND actively seizing.");
      }

      lines.push("• Repeat iSTAT/glucose in 30 minutes if abnormal.");
      return lines.join("\n");
    }
  },

  {
    id: "naloxone",
    name: "Altered mental status (P-01): Naloxone dose + drip setup",
    inputs: [
      { id:"route", label:"Route", type:"select",
        options:[{v:"iv", t:"IV"}, {v:"in", t:"Intranasal"}], default:"iv"
      },
      { id:"reversal_total_mg", label:"If drip needed: total naloxone used for reversal (mg)", type:"number", step:"0.1", min:"0", placeholder:"e.g., 4" }
    ],
    calc: (w, v) => {
      const lines = [];
      lines.push("NALOXONE (suspected opioid ingestion):");
      const bolusMg = clampMax(0.1 * w, 2.0);
      lines.push(`• Naloxone bolus: ${fmt(bolusMg," mg",2)} (0.1 mg/kg, max 2 mg/dose) via ${v.route.toUpperCase()}`);
      lines.push("  May repeat up to max total 10 mg if patient has response.");

      const total = Number(v.reversal_total_mg);
      if (isFinite(total) && total > 0) {
        const drip = total / 2;
        lines.push(`• Drip (if needed): start at half the reversal dose per hour → ${fmt(drip," mg/hr",2)} (example-based rule)`);
      } else {
        lines.push("• Drip (if needed): enter the total mg required for reversal to calculate half-dose/hr drip rate.");
      }
      return lines.join("\n");
    }
  },

  {
    id: "shock_vaso",
    name: "Shock (P-19): NS bolus + vasopressor infusion ranges",
    inputs: [
      { id:"show_bolus", label:"Show 20 mL/kg NS bolus (max 1000 mL)", type:"checkbox", default:true },
      { id:"pressors", label:"Show infusion ranges", type:"checkbox", default:true }
    ],
    calc: (w, v) => {
      const lines = [];
      lines.push("SHOCK – QUICK CALCS:");

      if (v.show_bolus) {
        const nsBolus = clampMax(20 * w, 1000);
        lines.push(`• Normal Saline bolus: ${fmt(nsBolus," mL",0)} (20 mL/kg, max 1000 mL)`);
      }

      if (v.pressors) {
        lines.push("\nVasopressor ranges (mcg/kg/min):");
        lines.push(`• Epinephrine: ${fmt(0.02,"–",2)}${fmt(1.0," mcg/kg/min",2)} → at ${fmt(w*0.02,"–",2)}${fmt(w*1.0," mcg/min",2)} for this weight`);
        lines.push(`• Norepinephrine: ${fmt(0.05,"–",2)}${fmt(1.0," mcg/kg/min",2)} → at ${fmt(w*0.05,"–",2)}${fmt(w*1.0," mcg/min",2)} for this weight`);
        lines.push(`• Dopamine: ${fmt(2,"–",0)}${fmt(20," mcg/kg/min",0)} → at ${fmt(w*2,"–",0)}${fmt(w*20," mcg/min",0)} for this weight`);
        lines.push(`• Dobutamine: ${fmt(2,"–",0)}${fmt(20," mcg/kg/min",0)} → at ${fmt(w*2,"–",0)}${fmt(w*20," mcg/min",0)} for this weight`);
      }

      return lines.join("\n");
    }
  }
];

/**
 * UI wiring
 */
const $ = (id) => document.getElementById(id);
const protocolSel = $("protocol");
const protocolInputs = $("protocolInputs");
const output = $("output");
const summaryLine = $("summaryLine");

function buildProtocolList() {
  protocolSel.innerHTML = "";
  for (const p of PROTOCOLS) {
    const opt = document.createElement("option");
    opt.value = p.id;
    opt.textContent = p.name;
    protocolSel.appendChild(opt);
  }
}

function renderInputsForProtocol(p) {
  protocolInputs.innerHTML = "";
  if (!p.inputs || p.inputs.length === 0) return;

  for (const inp of p.inputs) {
    const wrap = document.createElement("div");
    wrap.style.marginTop = "10px";

    const lab = document.createElement("label");
    lab.htmlFor = `inp_${inp.id}`;
    lab.textContent = inp.label;
    wrap.appendChild(lab);

    let el;
    if (inp.type === "select") {
      el = document.createElement("select");
      for (const o of inp.options || []) {
        const opt = document.createElement("option");
        opt.value = o.v;
        opt.textContent = o.t;
        el.appendChild(opt);
      }
      if (inp.default !== undefined) el.value = inp.default;
    } else if (inp.type === "checkbox") {
      el = document.createElement("input");
      el.type = "checkbox";
      el.style.width = "auto";
      el.style.transform = "scale(1.2)";
      el.checked = !!inp.default;
      // Put checkbox on same line
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.alignItems = "center";
      row.style.gap = "10px";
      row.appendChild(el);
      const text = document.createElement("div");
      text.className = "small muted";
      text.textContent = inp.help || "";
      row.appendChild(text);
      wrap.appendChild(row);
      el.id = `inp_${inp.id}`;
      protocolInputs.appendChild(wrap);
      continue;
    } else {
      el = document.createElement("input");
      el.type = inp.type || "text";
      if (inp.step) el.step = inp.step;
      if (inp.min !== undefined) el.min = inp.min;
      if (inp.max !== undefined) el.max = inp.max;
      if (inp.placeholder) el.placeholder = inp.placeholder;
      if (inp.default !== undefined) el.value = inp.default;
    }

    el.id = `inp_${inp.id}`;
    wrap.appendChild(el);

    if (inp.small) {
      const sm = document.createElement("div");
      sm.className = "small muted";
      sm.textContent = inp.small;
      wrap.appendChild(sm);
    }

    protocolInputs.appendChild(wrap);
  }
}

function getProtocolValues(p) {
  const v = {};
  for (const inp of (p.inputs || [])) {
    const el = $(`inp_${inp.id}`);
    if (!el) continue;
    if (inp.type === "checkbox") v[inp.id] = el.checked;
    else if (inp.type === "number") v[inp.id] = el.value === "" ? NaN : Number(el.value);
    else v[inp.id] = el.value;
  }
  return v;
}

function getWeightKg() {
  const w = Number($("weightKg").value);
  return isFinite(w) ? w : NaN;
}

function calculate() {
  const w = getWeightKg();
  const p = PROTOCOLS.find(x => x.id === protocolSel.value);

  if (!isFinite(w) || w <= 0) {
    output.textContent = "Please enter a valid weight in kg.";
    output.className = "warn";
    return;
  }
  if (!p) {
    output.textContent = "Please choose a protocol.";
    output.className = "warn";
    return;
  }

  const v = getProtocolValues(p);
  const res = p.calc(w, v);

  const units = $("units").value;
  const age = $("ageGroup").value;
  const lb = kgToLb(w);

  summaryLine.textContent =
    `Weight: ${fmt(w," kg",2)}${units==="us" ? ` (${fmt(lb," lb",1)})` : ""}` +
    (age ? ` • Age group: ${age}` : "") +
    ` • Protocol: ${p.name}`;

  output.textContent = res;
  output.className = "ok";
}

function resetScenarioInputs() {
  const p = PROTOCOLS.find(x => x.id === protocolSel.value);
  if (!p) return;
  for (const inp of (p.inputs || [])) {
    const el = $(`inp_${inp.id}`);
    if (!el) continue;
    if (inp.type === "checkbox") el.checked = !!inp.default;
    else if (inp.default !== undefined) el.value = inp.default;
    else el.value = "";
  }
  output.textContent = "Scenario inputs reset. Click Calculate.";
  output.className = "ok";
}

async function copyResults() {
  const text = `${summaryLine.textContent}\n\n${output.textContent}`;
  try {
    await navigator.clipboard.writeText(text);
    output.textContent = output.textContent + "\n\n(Copied to clipboard.)";
  } catch (e) {
    alert("Clipboard copy failed (browser may block). You can manually select & copy the results text.");
  }
}

protocolSel.addEventListener("change", () => {
  const p = PROTOCOLS.find(x => x.id === protocolSel.value);
  renderInputsForProtocol(p);
  output.textContent = "Click Calculate.";
  output.className = "ok";
});

$("calcBtn").addEventListener("click", calculate);
$("resetBtn").addEventListener("click", resetScenarioInputs);
$("copyBtn").addEventListener("click", copyResults);

buildProtocolList();
renderInputsForProtocol(PROTOCOLS[0]);
</script>
</body>
</html>
"""
out_path = Path("/mnt/data/pediatric_transport_dosage_calculator.html")
out_path.write_text(html, encoding="utf-8")
str(out_path)

